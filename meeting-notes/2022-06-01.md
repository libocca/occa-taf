# 2022-06-01

## Meeting Link

[Join the MS Teams meeting](https://teams.microsoft.com/l/meetup-join/19%3ameeting_NDBhZmQyMTUtMzEzMy00ZWJkLTkzZDAtMzRiZDg1YWU5OTQ3%40thread.v2/0?context=%7b%22Tid%22%3a%220cfca185-25f7-49e3-8ae7-704d5326e285%22%2c%22Oid%22%3a%22e76e8444-bf17-4212-b407-066369e3264c%22%7d)

## Attendees

- 

## Follow-up

- [x] [OCCA v1.3.0](https://github.com/libocca/occa/releases/tag/v1.3.0) is now available :tada:
   - Feedback related to this release can be provided in the [general discussion channel](https://github.com/libocca/occa/discussions/593) on GitHub

## Agenda

1. OCCA Execution Model  

## Notes

### OCCA Execution Model

#### Background

Currently the profiling interface provided through the `streamTag` class cannot be implemented for the SYCL/DPC++ backend. This is because a default constructed sycl::event will return immediately when waited on and cannot be used for timing. Events returned from kernel submission, however, can be used for profiling purposes.

The OCCA execution model follows CUDA, assuming in-order stream execution. Concurrent kernel execution on multiple streams can be accomplished using multiple streams; however, this is quite cumbersome.

```cpp
// Enqueue two independent kernels, k1 and k2, to 
// separate streams before calling a third kernel, 
// k3, which depends on these kernels.
occa::device d;

occa::stream s1 = d.createStream();
device.setStream(s1);
k1(Args...);
occa::streamTag t1 = d.tagStream();

occa::stream s2 = d.createStream();
device.setStream(s2);
k2(Args...);
occa::streamTag t2 = d.tagStream();

device.setStream(s1);
device.waitFor(t1);
device.waitFor(t2);
k3(Args...);
```

For backends using the launchedDevice/Kernel model, the launcher kernel exists purely for setting the grid/thread-block sizes when OKL kernels are used. When backend-specific kernels are used these must be set explicitly by the user by calling `kernel::setRunDims`; however, calling this function in the case when an OKL kernel is used does not alter grid/thread-block sizes. *This inconsistency has led to confusion for users in the past since no warning or error handling is provided.*

Finally, kernel arguments are first passed to the launcher kernel before being passed to the backend kernel, requiring the dynamic creation of a vector both times. 

#### Proposal 1

Introduce an event class which is compatible with the SYCL/DPC++ backend and provides additional functionality. Deprecate `streamTag` and associated functions of the `device` class.

```cpp
class event {
  void wait();
  static void wait(const std::vector<event>& event_list);
  std::vector<event> getDependencies();
  bool isRunning() const;
  bool isFinished() const;
  double startTime() const;
  double finishTime() const;
};
```

Add an interface for directly submitting a kernel to a specific `occa::stream`. Return an event object which can be used to express dependencies of subsequent kernel submissions.

```cpp
// Enqueue two independent kernels, k1 and k2, to 
// separate streams before calling a third kernel, 
// k3, which depends on these kernels.
occa::device d;

occa::stream s1 = d.createStream();
occa::event e1 = s1.enqueueKernel(k1,Args...);

occa::stream s2 = d.createStream();
occa::event e2 = s2.enqueueKernel(k2,Args...);

s1.enqueueKernel(k3,Args...,{e1,e2});
```

> **Note**: The OCCA C and Fortran APIs require users to call `occaKernelRun(â€¦)` explicitly.   

#### Proposal 2

If kernels are submitted directly to a specific stream, then the use of launcher kernels can be deprecated&mdash;provided that this interface takes arguments for the grid/thread-block dimensions.

```cpp
event stream::enqueueKernel(
  kernel& k,
  Args...,
  dim outer_dims,
  dim inner_dims,
  std::vector<event> dependencies = {}
);
```

#### Potential Future Proposals

- Make all memcpys asynchronous, return an event
- Stream pools
- Out-of-order streams


## Action Items

- [ ]

## Next Meeting

- [2022-06-15](2022-06-15.md)
